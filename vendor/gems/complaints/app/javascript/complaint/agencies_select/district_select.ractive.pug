select.form-control(id='{{tertiary_key}}', value='{{selected_id}}')
  option(value='0', disabled=true, selected=true) select district/metropolitan municipality...
  optgroup(label='Metropolitan municipalities')
    | {{#province_metro}}
    option(value='{{id}}') {{ name }}
    | {{/province_metro}}
  optgroup(label='District municipalities')
    | {{#province_districts}}
    option(value='{{id}}') {{ name }}
    | {{/province_districts}}

.quarternary('class-show'='district_is_selected')
  <localMunicipalitySelect quarternary_key='{{quarternary_key}}' local_municipalities='{{local_municipalities}}' agency_id='{{agency_id}}' />

style.
  select.form-control { width: auto; }
  .quarternary { display: none; }

script.
  import LocalMunicipalitySelect from './local_municipality_select.ractive.pug'

  export default Ractive.extend({
    template: $TEMPLATE,
    css: $CSS,
    components: {
      localMunicipalitySelect: LocalMunicipalitySelect,
    },
    computed:{
      selected_district(){
        if(this.get('district_is_selected')){
          return _(this.get('province_districts')).findWhere({id: this.get('selected_id')})
        }
      },
      local_municipalities(){
        if(this.get('district_is_selected')){
          return this.get('selected_district').local_municipalities
        }
      },
      province_metro_ids(){
        return _(this.get('province_metro')).map(function(pm){return pm.id})
      },
      province_district_ids(){
        return _(this.get('province_districts')).map(function(pd){return pd.id})
      },
      metro_selected(){
        return _(this.get('province_metro_ids')).contains(this.get('selected_id'))
      },
      district_is_selected(){
        return _(this.get('province_district_ids')).contains(this.get('selected_id'))
      },
      quarternary_key(){
        return this.get('selected_district').name.underscore()
      },
    },
    observe: {
      'selected_id': {
        handler(value, old, path, idx){
          if(this.get('metro_selected')){
              this.set('agency_id',value);
            }else if(this.get('district_is_selected')){
              this.set('agency_id',undefined);
            }
        }
      }
    },
  })
