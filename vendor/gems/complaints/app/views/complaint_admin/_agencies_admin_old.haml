%div
  .admin.well#agencies

:css
  .secondary.show, .tertiary.show, .quarternary.show{
    display: flex !important;
  }
  select#provincial_agencies_select, select#national_agencies_select, select#agencies_select, select#metro_district_select {
    width: auto;
  }
  #national_agencies_input {
    width: 260px;
  }
  #metro_or_district {
    width: 220px;
  }

%script#agency_form_template{type: 'template/html'}
  %div.inline{:style=>'display:flex'}
    %div
      %button.btn.btn-success.btn-xs#add_agency{:style => 'line-height:1.8;', :type => 'submit'}= t(".add_agency")
    <agenciesSelect provinces='{{provinces}}' />

%script#agency_template{:type => 'template/html'}
  %tr.agency
    %td.name {{ name }}

%script#agency_groups_template{type: 'template/html'}
  %table.table.borderless.agency_groups{:style => "width:auto;"}
    %tbody
      {{#agency_groups}}
      <agencyGroup classification='{{classification}}' agencies='{{agencies}}' />
      {{/agency_groups}}
      {{^agency_groups}}
      <tr><td id='empty'>None configured</td></tr>
      {{/agency_groups}}
  <agencyForm provinces='{{provinces}}' />

%script#agency_group_template{type: 'template/html'}
  %tr
    %td {{ classification }}
    %td
      %table
        %tbody
          {{#agencies}}
          <agency name='{{name}}' />
          {{/agencies}}

%script#agencies_select_template{type: 'template/html'}
  %div{style: 'display:flex;'}
    %select.form-control#agencies_select{value: '{{top_level_category}}'}
      %option#prompt{disabled: true, selected:'selected'} select...
      %option{value: "national"} National
      %option{value: "provincial_agencies"} Provincial
      %option{value: "municipalities"} Local
    .secondary{style: 'display: none', 'class-show':"national"}
      <nationalAgenciesSelect />
    .secondary{style: 'display: none', 'class-show':"provincial"}
      <provincialAgenciesSelect provinces='{{provinces}}' />
    .secondary{style: 'display: none', 'class-show':"local"}
      <localAgenciesProvinceSelect provinces='{{provinces}}' />

%script#national_agencies_select_template{type: 'template/html'}
  %select.form-control#national_agencies_select{ value:'{{national_agency_type}}' }
    %option#prompt{ disabled:true, selected:true } select national agency...
    %option{value:'government_agencies'} National government agencies
    %option{value:'government_institutions'} National government institutions
    %option{value:'democracy_institutions'} Democracy-supporting government institutions
  .tertiary{style:'display:none', 'class-show':'national_agencies_type_selected' }
    %input#national_agencies_input{type: 'text', placeholder: '{{placeholder}}'}

%script#provincial_agencies_select_template{type: 'template/html'}
  %select.form-control#provincial_agencies_select{ value:'{{province_id}}' }
    %option#prompt{ disabled:true, selected:true } select province...
    {{#provinces}}
    %option{value:'{{id}}'} {{name}}
    {{/provinces}}
  .tertiary{style:'display:none', 'class-show':'provincial_agencies_type_selected' }
    %input{type: 'text', placeholder: '{{placeholder}}'}

%script#local_agencies_province_select_template{type: 'template/html'}
  %select#local_agencies_province_select{value: '{{local_agency_province_id}}'}
    %option{disabled:true, selected:true} select province...
    {{#provinces}}
    %option{value: '{{id}}'} {{name}}
    {{/provinces}}
  .tertiary{style:'display:none', 'class-show':'local_agencies_province_selected' }
    <metroDistrictSelect />

%script#metro_district_select_template{type: 'template/html'}
  %select#metro_district_select{value: '{{metro_or_district}}'}
    %option{disabled:true, selected:true} select...
    %option{value: 'metro'} Metropolitan municipality
    %option{value: 'district'} District municipality
  .quarternary{style:'display:none', 'class-show':'metro_or_district_selected' }
    %input#metro_or_district{type: 'text', placeholder: '{{placeholder}}'}


:coffeescript
  $ ->
    agency_groups_data = #{@agency_groups.html_safe}
    provinces_data = #{@provinces.html_safe}

    MetroDistrictSelect = Ractive.extend
      template: '#metro_district_select_template'
      computed:
        metro_or_district_selected: -> ['metro', 'district'].indexOf(this.get('metro_or_district')) != -1
        placeholder: -> if this.get('metro_or_district') == 'metro' then 'enter metropolitan municipality'
        else if this.get('metro_or_district') == 'district' then 'enter district municipality'

    ProvincialAgenciesSelect = Ractive.extend
      template: '#provincial_agencies_select_template'
      data:
        placeholder: 'enter provincial agency'
      computed:
        provincial_agencies_type_selected: -> typeof this.get('province_id') != 'undefined'

    LocalAgenciesProvinceSelect = Ractive.extend
      template: '#local_agencies_province_select_template'
      computed:
        local_agencies_province_selected: -> typeof this.get('local_agency_province_id') != 'undefined'
      components:
        metroDistrictSelect: MetroDistrictSelect

    NationalAgenciesSelect = Ractive.extend
      template: '#national_agencies_select_template'
      computed:
        national_agencies_type_selected: -> typeof this.get('national_agency_type') != 'undefined'
        placeholder: -> if this.get('national_agency_type')=='government_agencies' then 'enter government agency'
        else if this.get('national_agency_type')=='government_institutions' then 'enter government institution'
        else if this.get('national_agency_type')=='democracy_institutions' then 'enter democracy-supporting institution'

    AgenciesSelect = Ractive.extend
      template: '#agencies_select_template',
      components:
        nationalAgenciesSelect: NationalAgenciesSelect
        provincialAgenciesSelect: ProvincialAgenciesSelect
        localAgenciesProvinceSelect: LocalAgenciesProvinceSelect
      computed:
        national: -> this.get('top_level_category') == 'national'
        provincial: -> this.get('top_level_category') == 'provincial_agencies'
        local: -> this.get('top_level_category') == 'municipalities'

    AgencyForm = Ractive.extend
      template: '#agency_form_template'
      components:
        agenciesSelect: AgenciesSelect

    Agency = Ractive.extend
      template: '#agency_template'

    AgencyGroup = Ractive.extend
      template: '#agency_group_template'
      components:
        agency: Agency

    window.agency_groups = new Ractive
      el: '#agencies'
      template: '#agency_groups_template'
      data:
        agency_groups: agency_groups_data
        provinces: provinces_data
      components:
        agencyGroup: AgencyGroup
        agencyForm: AgencyForm

  $ ->
    window.flash_error_template = _.template("<ul class='error'><li>{{message}}</li></ul>")

    delete_url = "#{agency_url('id')}"
    el = $(".agencies tbody")
    form = $("#new_agency")
    empty_string = "<tr><td id='empty'>#{ t('.empty')}</td></tr>"

    if agencies.length == 0
      el.append empty_string
    else
      _.each agencies, (agency)->
        el.append agency_template({agency : agency})

    $('body').on 'click', ->
      $('#invalid_agency_error').remove()
      $('#duplicate_agency_error').remove()
      $('#delete_disallowed').remove()

    form.bind "ajax:before", (e)->
      if $('#agency_name').val() == '' || $('#agency_full_name').val() == ''
        $('form#new_agency div.inline').append("<div id='invalid_agency_error' class='error' style='margin-left:30px;'>fields cannot be blank</div>")
        false
      else if _(agency_names).includes($('#agency_name').val().toLowerCase())
        $('form#new_agency div.inline').append("<div id='duplicate_agency_error' class='error' style='margin-left:30px;'>duplicate agency not allowed</div>")
        false
      else if _(agency_full_names).includes($('#agency_full_name').val().toLowerCase())
        $('form#new_agency div.inline').append("<div id='duplicate_agency_error' class='error' style='margin-left:30px;'>duplicate agency not allowed</div>")
        false
      else
        $('#invalid_agency_error').remove()
        true

    form.bind "ajax:success", (e,data,status,xhr)->
      el.append agency_template(agency : data)
      form[0].reset()
      $('td#empty',el).closest('tr').remove()
      $('.message_block').html ''

    el.on 'click', "a.delete_agency", (e)->
      e.preventDefault()
      e.stopPropagation()
      context = $(@).closest('tr')
      if context.data('deleteAllowed')
        id = context.data('agencyId')
        url = delete_url.replace(/id$/,id)
        $.ajax
          url: url
          method: 'delete'
          context: context # becomes 'this' in the callback
          error: (jqxhr, status, statusText)-> # normal response is 410 'gone'
            if jqxhr.status == 410
              this.remove()
              if el.find(".agency").length == 0
                el.append empty_string
      else
        $(e.target).parent().after("<td id='delete_disallowed' class='error' style='margin-left:30px;'>cannot delete an agency that is associated with complaints</td>")
