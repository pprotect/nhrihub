require 'rails_helper'
$:.unshift File.expand_path '../../helpers', __FILE__
require 'login_helpers'
require 'complaint_admin_spec_helpers'
require 'navigation_helpers'
require 'complaint_context_file_admin_spec_helpers'
require 'communication_context_file_admin_spec_helpers'
require 'shared_behaviours/file_admin_behaviour'

feature "complaint bases admin", :js => true do
  include LoggedInEnAdminUserHelper # sets up logged in admin user
  include ComplaintAdminSpecHelpers

  scenario "out with the old" do
    visit complaint_admin_path('en')
    expect(page).not_to have_selector('h4',text: "Good Governance Subareas")
    expect(page).not_to have_selector('h4',text: "Special Investigations Unit Subareas")
    expect(page).not_to have_selector('h4',text: "Corporate Services Subareas")
  end

  scenario "in with the new" do
    visit complaint_admin_path('en')
    expect(page).to have_selector('h4', text: "Areas and subareas")
  end

  scenario "no complaint bases configured" do
    visit complaint_admin_path('en')
    sleep(0.1)
    expect(page).to have_selector '#good_governance_subareas #empty'
    expect(page).to have_selector '#siu_subareas #empty'
    expect(page).to have_selector '#strategic_plan_subareas #empty'
  end

  scenario "special investigations unit complaint bases configured" do
    Siu::ComplaintBasis.create(:name=>"foo")
    visit complaint_admin_path('en')
    expect(page.find('#siu_subareas .siu_subarea').text).to eq "foo"
  end

  scenario "good governance complaint bases configured" do
    GoodGovernance::ComplaintBasis.create(:name=>"foo")
    visit complaint_admin_path('en')
    expect(page.find('#good_governance_subareas .good_governance_subarea').text).to eq "foo"
  end

  scenario "strategic plan complaint bases configured" do
    StrategicPlans::ComplaintBasis.create(:name=>"foo")
    visit complaint_admin_path('en')
    expect(page.find('#strategic_plan_subareas .strategic_plan_subarea').text).to eq "foo"
  end

  scenario "add siu complaint basis" do
    visit complaint_admin_path('en')
    sleep(0.1)
    expect(page).to have_selector '#siu_subareas #empty'
    page.find('#siu_subareas #siu_subarea_name').set('A thing')
    expect{ new_siu_complaint_subarea_button.click; wait_for_ajax }.to change{ Siu::ComplaintBasis.all.map(&:name) }.from([]).to(["A thing"])
    expect(page.find('#siu_subareas .siu_subarea').text).to eq "A thing"
    expect(page).not_to have_selector '#siu_subareas #empty'
    page.find('#siu_subareas #siu_subarea_name').set('Another thing')
    expect{ new_siu_complaint_subarea_button.click; wait_for_ajax }.to change{ Siu::ComplaintBasis.count }.from(1).to(2)
    expect(page.all('#siu_subareas .siu_subarea')[1].text).to eq "Another thing"
  end

  scenario "add gg complaint basis" do
    visit complaint_admin_path('en')
    sleep(0.1)
    expect(page).to have_selector '#good_governance_subareas #empty'
    page.find('#good_governance_subareas #good_governance_subarea_name').set('A thing')
    expect{ new_gg_complaint_subarea_button.click; wait_for_ajax }.to change{ GoodGovernance::ComplaintBasis.all.map(&:name) }.from([]).to(["A thing"])
    expect(page.find('#good_governance_subareas .good_governance_subarea').text).to eq "A thing"
    expect(page).not_to have_selector '#good_governance_subareas #empty'
    page.find('#good_governance_subareas #good_governance_subarea_name').set('Another thing')
    expect{ new_gg_complaint_subarea_button.click; wait_for_ajax }.to change{ GoodGovernance::ComplaintBasis.count }.from(1).to(2)
    expect(page.all('#good_governance_subareas .good_governance_subarea')[1].text).to eq "Another thing"
  end

  scenario "add strategic plan complaint basis" do
    visit complaint_admin_path('en')
    sleep(0.1)
    expect(page).to have_selector '#strategic_plan_subareas #empty'
    page.find('#strategic_plan_subareas #strategic_plan_subarea_name').set('A thing')
    expect{ new_strategic_plan_complaint_subarea_button.click; wait_for_ajax }.to change{ StrategicPlans::ComplaintBasis.all.map(&:name) }.from([]).to(["A thing"])
    expect(page.find('#strategic_plan_subareas .strategic_plan_subarea').text).to eq "A thing"
    expect(page).not_to have_selector '#strategic_plan_subareas #empty'
    page.find('#strategic_plan_subareas #strategic_plan_subarea_name').set('Another thing')
    expect{ new_strategic_plan_complaint_subarea_button.click; wait_for_ajax }.to change{ StrategicPlans::ComplaintBasis.count }.from(1).to(2)
    expect(page.all('#strategic_plan_subareas .strategic_plan_subarea')[1].text).to eq "Another thing"
  end

  scenario "add duplicate complaint basis under same mandate" do
    GoodGovernance::ComplaintBasis.create(:name => "A thing")
    visit complaint_admin_path('en')
    sleep(0.1)
    page.find('#good_governance_subareas #good_governance_subarea_name').set('A thing')
    expect{ new_gg_complaint_subarea_button.click; wait_for_ajax }.not_to change{ GoodGovernance::ComplaintBasis.count }
    expect( flash_message ).to eq "Complaint basis already exists, must be unique."
  end

  scenario "add duplicate complaint basis under different mandate" do
    Siu::ComplaintBasis.create(:name => "A thing")
    visit complaint_admin_path('en')
    sleep(0.1)
    page.find('#good_governance_subareas #good_governance_subarea_name').set('A thing')
    expect{ new_gg_complaint_subarea_button.click; wait_for_ajax }.to change{ GoodGovernance::ComplaintBasis.count }.by(1)
  end

  scenario "delete an siu complaint basis" do
    Siu::ComplaintBasis.create(:name => "A thing")
    visit complaint_admin_path('en')
    expect{ delete_complaint_subarea("A thing").click; wait_for_ajax }.to change{ Siu::ComplaintBasis.count }.by -1
    expect(page).to have_selector '#siu_subareas #empty'
  end

  scenario "delete a good governance complaint basis" do
    GoodGovernance::ComplaintBasis.create(:name => "A thing")
    visit complaint_admin_path('en')
    expect{ delete_complaint_subarea("A thing").click; wait_for_ajax }.to change{ GoodGovernance::ComplaintBasis.count }.by -1
    expect(page).to have_selector '#good_governance_subareas #empty'
  end

  scenario "delete a strategic plan complaint basis" do
    StrategicPlans::ComplaintBasis.create(:name => "A thing")
    visit complaint_admin_path('en')
    expect{ delete_complaint_subarea("A thing").click; wait_for_ajax }.to change{ StrategicPlans::ComplaintBasis.count }.by -1
    expect(page).to have_selector '#strategic_plan_subareas #empty'
  end
end

feature "complaint file admin", :js => true do
  include ComplaintAdminSpecHelpers
  include ComplaintContextFileAdminSpecHelpers
  it_should_behave_like "file admin"
end

feature "communication file admin", :js => true do
  include ComplaintAdminSpecHelpers
  include CommunicationContextFileAdminSpecHelpers
  it_should_behave_like "file admin"
end

feature "agency admin", :js => true do
  include LoggedInEnAdminUserHelper # sets up logged in admin user
  include ComplaintAdminSpecHelpers
  scenario "none configured yet" do
    visit complaint_admin_path('en')
    expect(page).to have_selector("h4",:text=>"Agencies")
    expect(page).to have_selector('#agencies td#empty', :text => "None configured")
  end

  scenario "some agencies are configured" do
    FactoryBot.create(:agency, :name => "ABC", :full_name => "Anywhere But Colma")
    visit complaint_admin_path('en')
    expect(page).to have_selector('#agencies .agency td.name', :text => 'ABC')
    expect(page).to have_selector('#agencies .agency td.full_name', :text => 'Anywhere But Colma')
  end

  scenario "add a valid agency" do
    visit complaint_admin_path('en')
    page.find('form#new_agency input#agency_name').set('ABC')
    page.find('form#new_agency input#agency_full_name').set('Anywhere But Calaveras')
    expect{page.find('button#add_agency').click; wait_for_ajax}.to change{Agency.count}.from(0).to(1)
    expect(page).not_to have_selector('#agencies td#empty', :text => "None configured")
    expect(page).to have_selector('#agencies .agency td.name', :text => 'ABC')
    expect(page).to have_selector('#agencies .agency td.full_name', :text => 'Anywhere But Calaveras')
    expect(page.find('form#new_agency input#agency_name').value).to eq ''
    expect(page.find('form#new_agency input#agency_full_name').value).to eq ''
  end

  scenario "add an invalid agency (blank name)" do
    visit complaint_admin_path('en')
    page.find('form#new_agency input#agency_name').set('ABC')
    expect{page.find('button#add_agency').click; wait_for_ajax}.not_to change{Agency.count}
    expect(page).to have_selector('#invalid_agency_error', :text => "fields cannot be blank")
    page.find('form#new_agency input#agency_full_name').click
    expect(page).not_to have_selector('#invalid_agency_error')
  end

  scenario "add an invalid agency (blank name)" do
    visit complaint_admin_path('en')
    page.find('form#new_agency input#agency_full_name').set('Anywhere But Chelmsford')
    expect{page.find('button#add_agency').click; wait_for_ajax}.not_to change{Agency.count}
    expect(page).to have_selector('#invalid_agency_error', :text => "fields cannot be blank")
    page.find('form#new_agency input#agency_name').click
    expect(page).not_to have_selector('#invalid_agency_error')
  end

  scenario "add an agency with duplicate name" do
    FactoryBot.create(:agency, :name => "ABC", :full_name => "Anywhere But Colma")
    visit complaint_admin_path('en')
    page.find('form#new_agency input#agency_name').set('abc') # case insensitive
    page.find('form#new_agency input#agency_full_name').set('Anywhere But Chelmsford')
    expect{page.find('button#add_agency').click; wait_for_ajax}.not_to change{Agency.count}
    expect(page).to have_selector('#duplicate_agency_error', :text => "duplicate agency not allowed")
    page.find('form#new_agency input#agency_name').click
    expect(page).not_to have_selector('#duplicate_agency_error')
  end

  scenario "add an agency with duplicate full name" do
    FactoryBot.create(:agency, :name => "ABC", :full_name => "Anywhere But Colma")
    visit complaint_admin_path('en')
    page.find('form#new_agency input#agency_name').set('XYZ')
    page.find('form#new_agency input#agency_full_name').set('Anywhere But colma') # case insensitive!
    expect{page.find('button#add_agency').click; wait_for_ajax}.not_to change{Agency.count}
    expect(page).to have_selector('#duplicate_agency_error', :text => "duplicate agency not allowed")
    page.find('form#new_agency input#agency_full_name').click
    expect(page).not_to have_selector('#duplicate_agency_error')
  end

  scenario "delete an agency that is not associated with any complaint" do
    FactoryBot.create(:agency, :name => "ABC", :full_name => "Anywhere But Colma")
    visit complaint_admin_path('en')
    expect{find("#agencies .agency .delete_agency").click; wait_for_ajax}.to change{Agency.count}.from(1).to(0)
  end

  scenario "delete an agency that is already associated with a complaint" do
    agency = FactoryBot.create(:agency, :name => "ABC", :full_name => "Anywhere But Colma")
    FactoryBot.create(:complaint, :agencies => [agency])
    visit complaint_admin_path('en')
    expect{find("#agencies .agency .delete_agency").click; wait_for_ajax}.not_to change{Agency.count}
    expect(page).to have_selector('#delete_disallowed', :text => "cannot delete an agency that is associated with complaints")
    find('h1').click # click anywhere, 'body' doesn't seem to work anymore
    expect(page).not_to have_selector('#delete_disallowed')
  end
end
